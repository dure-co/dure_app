name: "dure tauri2 desktop,android build release 🛠️"

# on: [push, pull_request] # this event does not activated with act -v cmd
on:
  workflow_dispatch:
#   push:
#     tags:
#       - "v[0-9]+.[0-9]+.[0-9]+"

# on:
#   push:
#     branches: [ "master" ]
#   pull_request:
#     branches: [ "master" ]

jobs:
  # desktop:
  #   strategy:
  #     matrix:
  #       # os: [macos-latest, ubuntu-latest, windows-latest]
  #       os: [ubuntu-latest]
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Rust Cache
  #       uses: actions/cache@v4.1.2
  #       with:
  #         key: "android-rust"
  #         path: "packages/dure_app/_tauri/target/**"
  #     - name: Install Linux deps
  #       if: matrix.os == 'ubuntu-latest'
  #       run: |
  #         sudo apt install libwebkit2gtk-4.1-dev \
  #         build-essential \
  #         curl \
  #         wget \
  #         file \
  #         libxdo-dev \
  #         libssl-dev \
  #         libayatana-appindicator3-dev \
  #         librsvg2-dev \
  #         librust-openssl-sys-dev
  #     - name: Setup Node v22
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 22.x
  #     - name: Install npm deps
  #       run: cd packages/dure_app; npm install -g pnpm; pnpm install
  #     - name: Build
  #       run: cd packages/dure_app; pnpm run tauri build
  #     - name: Upload Build Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ${{ matrix.os }}-build
  #         path: |
  #           packages/dure_app/_tauri/target/debug/bundle/**/*
  # release
  #    packages/dure_app/_tauri/target/release/bundle/**/*
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Rust Cache
        uses: actions/cache@v4.1.2
        with:
          key: "android-rust"
          path: "packages/dure_app/_tauri/target/**"
      - name: Setup Node v22
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          # cache: gradle
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2.0.10
        with:
          api-level: 31
          build-tools: 31.0.0
          ndk: 23.1.7779620
      - run: |
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
      # - name: Install ssl dependencies
      #   run: sudo apt install libssl-dev pkg-config libudev-dev librust-openssl-sys-dev
      - name: Install npm deps
        run: cd packages/dure_app; npm install -g pnpm; pnpm install
      - name: Setup Rust targets
        run: rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android
      - name: Setup Android Signing
        run: |
          cd packages/dure_app/_tauri/gen/android
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" > keystore.properties
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> keystore.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> keystore.properties
          base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > $RUNNER_TEMP/keystore.jks
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties
      ## key generated by following commands
      ## echo y | keytool -genkeypair -dname "cn=Woojae Park, ou=app, o=dure, c=KR" -alias business -keypass keypass -keystore android.keystore  -storepass keypass -validity 20000 -keyalg RSA
      ## base64 android.keystore |  awk '{print}' ORS=''
      ## ANDROID_KEY_ALIAS=business
      ## ANDROID_KEYSTORE_PASSWORD=keypass
      ## ANDROID_KEY_PASSWORD=keypass
      ## ANDROID_KEY_BASE64=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
      - name: Build
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
        run: |
          # export TOOLCHAIN=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          # export TARGET=aarch64-linux-android
          # export API=31

          # export AR=$TOOLCHAIN/bin/llvm-ar
          # export CC=$TOOLCHAIN/bin/$TARGET$API-clang
          # export AS=$CC
          # export CXX=$TOOLCHAIN/bin/$TARGET$API-clang++
          # export LD=$TOOLCHAIN/bin/ld
          # export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          # export STRIP=$TOOLCHAIN/bin/llvm-strip

          # export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          # export PATH=$PATH:$TOOLCHAIN/bin

          cd packages/dure_app; pnpm run tauri android build

      # release build files
      #    ls _tauri/gen/android/app/build/outputs/apk/universal/release

      # - name: Upload Unsigned APK
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: app-universal-release-unsigned.apk
      #     path: packages/dure_app/_tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk

      # - name: Upload Universal AAB
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: app-universal-release.aab
      #     path: packages/dure_app/_tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab

      - name: Convert aab to apk
        id: convert_aab
        uses: mukeshsolanki/bundletool-action@v1.0.0
        with:
          # release
          aabFile: packages/dure_app/_tauri/gen/android/app/build/outputs/bundle/universalRelease/app-universal-release.aab
          # debug
          # aabFile: packages/dure_app/_tauri/gen/android/app/build/outputs/bundle/universalDebug/app-universal-debug.aab
          base64Keystore: ${{ secrets.ANDROID_KEY_BASE64 }}
          keystorePassword: "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
          keystoreAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword: "${{ secrets.ANDROID_KEY_PASSWORD }}"
          bundletoolVersion: "latest"

      - name: Upload Universal APK
        uses: actions/upload-artifact@v3
        with:
          name: app-universal-release.apk
          path: app-universal-release.apk
          # path: app-universal-debug.apk

  # release:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - android
  #     - desktop
  #   steps:
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4
  #     - run: ls
